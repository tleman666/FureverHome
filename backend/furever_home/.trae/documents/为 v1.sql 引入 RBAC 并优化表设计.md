# 目标
- 新增 RBAC 权限模型并提供初始化数据脚本
- 优化 `users` 表以支持安全密码存储与审计字段
- 提供一套可直接执行的 DDL + DML（不包含任何视图）

## 执行顺序
1) 创建 RBAC 表：`roles`、`permissions`、`user_roles`、`role_permissions`
2) 优化 `users` 表（密码哈希、审计字段）
3) 初始化 RBAC 数据：角色、权限、角色-权限映射、用户-角色映射
4) 初始化业务数据：用户、动物、帖子、评论、点赞、聊天与消息、领养与评分

## DDL：新增 RBAC 表
```sql
CREATE TABLE roles (
  role_id INT AUTO_INCREMENT PRIMARY KEY,
  role_code VARCHAR(50) NOT NULL UNIQUE,
  role_name VARCHAR(50) NOT NULL,
  description VARCHAR(200) DEFAULT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE permissions (
  permission_id INT AUTO_INCREMENT PRIMARY KEY,
  perm_code VARCHAR(100) NOT NULL UNIQUE,
  perm_name VARCHAR(100) NOT NULL,
  description VARCHAR(200) DEFAULT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE user_roles (
  user_id INT NOT NULL,
  role_id INT NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (user_id, role_id),
  CONSTRAINT fk_user_roles_user FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT fk_user_roles_role FOREIGN KEY (role_id) REFERENCES roles(role_id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE role_permissions (
  role_id INT NOT NULL,
  permission_id INT NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (role_id, permission_id),
  CONSTRAINT fk_role_permissions_role FOREIGN KEY (role_id) REFERENCES roles(role_id) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT fk_role_permissions_perm FOREIGN KEY (permission_id) REFERENCES permissions(permission_id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## DDL：优化 `users` 表
```sql
ALTER TABLE users
  CHANGE COLUMN password password_hash VARCHAR(255) NOT NULL,
  MODIFY email VARCHAR(255) NOT NULL,
  ADD COLUMN status ENUM('正常','禁用') NOT NULL DEFAULT '正常' AFTER credit_score_count,
  ADD COLUMN updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP AFTER create_time,
  ADD COLUMN last_login_at TIMESTAMP NULL DEFAULT NULL AFTER updated_at;
```

## DML：初始化 RBAC 种子
```sql
INSERT INTO roles (role_code, role_name, description) VALUES
('ADMIN','管理员','系统最高权限'),
('MOD','版主','内容审核与管理'),
('USER','用户','普通用户权限');

INSERT INTO permissions (perm_code, perm_name, description) VALUES
('user:read','用户查看',NULL),('user:ban','用户封禁',NULL),
('animal:create','动物创建',NULL),('animal:read','动物查看',NULL),('animal:review','动物审核',NULL),
('adopt:apply','提交领养申请',NULL),('adopt:review','审核领养申请',NULL),('adopt:read','领养记录查看',NULL),
('post:create','帖子创建',NULL),('post:read','帖子查看',NULL),('post:delete','帖子删除',NULL),
('comment:create','评论创建',NULL),('comment:read','评论查看',NULL),('comment:delete','评论删除',NULL),
('chat:start','发起聊天',NULL),('chat:send_message','发送消息',NULL),('chat:read','聊天查看',NULL),
('rating:create','评分创建',NULL),('rating:read','评分查看',NULL),('rating:delete','评分删除',NULL);

INSERT INTO role_permissions (role_id, permission_id)
SELECT r.role_id, p.permission_id FROM roles r CROSS JOIN permissions p WHERE r.role_code='ADMIN';

INSERT INTO role_permissions (role_id, permission_id)
SELECT r.role_id, p.permission_id FROM roles r JOIN permissions p
  ON r.role_code='MOD' AND p.perm_code IN (
    'animal:read','animal:review',
    'adopt:read','adopt:review',
    'post:read','post:delete',
    'comment:read','comment:delete',
    'chat:read','rating:read'
  );

INSERT INTO role_permissions (role_id, permission_id)
SELECT r.role_id, p.permission_id FROM roles r JOIN permissions p
  ON r.role_code='USER' AND p.perm_code IN (
    'animal:create','animal:read',
    'adopt:apply','adopt:read',
    'post:create','post:read',
    'comment:create','comment:read',
    'chat:start','chat:send_message','chat:read',
    'rating:create','rating:read'
  );
```

## DML：初始化用户
```sql
INSERT INTO users (user_name, user_age, password_hash, email, avatar_url, sex, location, proof_text, proof_photo)
VALUES
('admin', 30, '$2a$10$eImG8G7G7G7G8G7G8G7G8uOqzTQn5Jf0gDsw4hV1Bf6e2bC/1aQyS', 'admin@example.com', NULL, '男', '福州', NULL, NULL),
('mod',   28, '$2a$10$eImG8G7G7G7G8G7G8G7G8uOqzTQn5Jf0gDsw4hV1Bf6e2bC/1aQyS', 'mod@example.com',   NULL, '女', '福州', NULL, NULL),
('alice', 24, '$2a$10$eImG8G7G7G7G8G7G8G7G8uOqzTQn5Jf0gDsw4hV1Bf6e2bC/1aQyS', 'alice@example.com', NULL, '女', '厦门', '多年养宠经验', JSON_ARRAY('https://img.example.com/p1.jpg')),
('bob',   26, '$2a$10$eImG8G7G7G7G8G7G8G7G8uOqzTQn5Jf0gDsw4hV1Bf6e2bC/1aQyS', 'bob@example.com',   NULL, '男', '泉州', NULL, NULL);

INSERT INTO user_roles (user_id, role_id)
SELECT u.user_id, r.role_id FROM users u JOIN roles r ON u.user_name='admin' AND r.role_code='ADMIN';
INSERT INTO user_roles (user_id, role_id)
SELECT u.user_id, r.role_id FROM users u JOIN roles r ON u.user_name='mod' AND r.role_code='MOD';
INSERT INTO user_roles (user_id, role_id)
SELECT u.user_id, r.role_id FROM users u JOIN roles r ON u.user_name IN ('alice','bob') AND r.role_code='USER';
```

## DML：初始化业务数据
```sql
INSERT INTO animal (user_id, animal_name, photo_urls, species, breed, gender, animal_age, health_status, is_sterilized, adoption_status, short_description)
SELECT u.user_id, '雪球', JSON_ARRAY('https://img.example.com/cat1.jpg'), '猫', '英短', '母', 12, '健康', '是', '短期领养', '活泼可爱'
FROM users u WHERE u.user_name='alice';

INSERT INTO post (user_id, title, content, media_urls)
SELECT u.user_id, '关于雪球的日常', '雪球很黏人，欢迎了解', JSON_ARRAY('https://img.example.com/cat1-post.jpg')
FROM users u WHERE u.user_name='alice';

INSERT INTO comments (post_id, user_id, content)
SELECT p.post_id, u.user_id, '好可爱！'
FROM post p JOIN users u ON p.title='关于雪球的日常' AND u.user_name='bob';

INSERT INTO likes (user_id, kind, target_id)
SELECT u.user_id, '帖子', p.post_id
FROM users u JOIN post p ON u.user_name='bob' AND p.title='关于雪球的日常';

INSERT INTO chat (creator_id, receiver_id, create_time)
SELECT u1.user_id, u2.user_id, CURRENT_TIMESTAMP
FROM users u1 JOIN users u2 ON u1.user_name='alice' AND u2.user_name='bob';

INSERT INTO message (chat_id, sender_id, content)
SELECT c.chat_id, u.user_id, '你好，想了解雪球的情况'
FROM chat c JOIN users u ON u.user_name='bob'
ORDER BY c.chat_id DESC LIMIT 1;

INSERT INTO adopt (animal_id, user_id, application_status, living_environment, house_type, has_other_pets, family_member_count, has_child, adopt_reason, month_salary, pass_time)
SELECT a.animal_id, u.user_id, '申请成功', '公寓', '租用', FALSE, 2, FALSE, '非常喜欢猫咪，有稳定收入', 8000, CURRENT_TIMESTAMP
FROM animal a JOIN users u ON a.animal_name='雪球' AND u.user_name='bob';

INSERT INTO rating (user_id, adopt_id, score, content)
SELECT ur.user_id, ad.adopt_id, 5, '领养过程顺利，沟通良好'
FROM users ur JOIN adopt ad ON ur.user_name='alice';
```

## 验证建议
- 按顺序执行，确保父表数据先插入以满足外键
- 使用 `SELECT` 验证：角色/权限数量、用户-角色绑定、业务数据是否就绪
- 可根据查询热点后续补充索引（如 `post(user_id, create_time)`、`message(chat_id, create_time)` 等）